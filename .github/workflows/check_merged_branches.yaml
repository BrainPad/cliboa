name: cliboa-check-branches

on:
  workflow_dispatch:
  schedule:
    - cron: '20 0 1 * *'

jobs:
  check-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and list merged branches
        id: find_branches
        run: |
          # Find all remote branches merged into master, excluding master itself.
          MERGED_BRANCHES=$(git branch -r --merged origin/master | grep -v 'master' | sed 's/ *origin\///' | tr -d '\n')

          BRANCHES_TO_DELETE=""
          for branch in ${MERGED_BRANCHES}; do
            if [[ ${branch} =~ ^v[0-9]+\.[0-9]+$ ]]; then
              if [[ -n "$(git tag -l "${branch}*")" ]]; then
                echo "âŒ Branch '${branch}' is a released version branch. It should be deleted."
                BRANCHES_TO_DELETE="${BRANCHES_TO_DELETE} ${branch}"
              else
                echo "âœ… Branch '${branch}' is a future version branch."
              fi
            else
              echo "âŒ Branch '${branch}' is a regular merged branch. It should be deleted."
              BRANCHES_TO_DELETE="${BRANCHES_TO_DELETE} ${branch}"
            fi
          done

          BRANCHES_TO_DELETE=$(echo "${BRANCHES_TO_DELETE}" | xargs)

          # Check if the list of merged branches is not empty.
          if [[ -n "${BRANCHES_TO_DELETE}" ]]; then
            echo "::error::The following remote branches have been merged into master but not deleted:"
            echo "${BRANCHES_TO_DELETE}"
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "merged_branches=${BRANCHES_TO_DELETE}" >> $GITHUB_OUTPUT
          else
            echo "No merged remote branches found. Great job! ðŸ‘"
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Fail the CI if merged branches exist
        if: steps.find_branches.outputs.status == 'fail'
        run: |
          echo "Failing the CI check because deletable merged branches were found."
          exit 1
