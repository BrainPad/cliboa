name: cliboa-security

on: [push, pull_request]

jobs:
  git_secrets:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: install git-secrets
        run: |
          sudo ln -s "$(which echo)" /usr/local/bin/say
          git clone https://github.com/awslabs/git-secrets.git /tmp/git-secrets
          cd /tmp/git-secrets
          sudo make install
      - name: setup and scan git-secrets
        run: |
          git secrets --install
          # add aws secrets
          git secrets --register-aws
          # add other secrets
          git secrets --add "password\s*=\s*\".+\""
          git secrets --add --allowed "password\s*=\"dummy.*\""
          # list rules
          echo "---- Registered patterns ----"
          git secrets --list
          # check
          echo "---- Scanning repository (tracked files only) ----"
          git ls-files -z | xargs -0 git secrets --scan
